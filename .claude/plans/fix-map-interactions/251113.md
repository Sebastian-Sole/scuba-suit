# Fix Map Interaction Issues Implementation Plan

## Overview

Fix three critical bugs in the map interaction system: right-click not triggering location selection, cursor coordinates not updating continuously, and map flashing/re-rendering when marker is placed.

## Current State Analysis

**Existing Implementation:**
- MapLibre GL map with right-click handler at `src/components/SSTMap.tsx:105-136`
- Marker creation logic at `src/components/SSTMap.tsx:138-158`
- Cursor tracking at `src/components/SSTMap.tsx:167-204`
- MapHelpMenu showing cursor coordinates at `src/components/MapHelpMenu.tsx:74-88`

**Bugs Identified:**

1. **Right-click doesn't trigger location selection/search**
   - Handler exists and calls `onMapClick` correctly (line 112)
   - Marker update logic present (lines 114-128)
   - Root cause: Race condition - marker ref can be null when right-click happens
   - The marker creation effect depends on `[isMapLoaded]` (line 158)
   - Right-click effect also depends on `[onMapClick, isMapLoaded]` (line 136)
   - When both effects run simultaneously, marker.current may not be set yet

2. **Cursor position set once, doesn't update as cursor moves**
   - Mousemove handler IS registered correctly (line 194)
   - Uses requestAnimationFrame for performance (lines 171-184)
   - Root cause: Effect dependency `[isMapLoaded]` (line 204) means it only runs when that value changes
   - After initial setup, the effect never re-runs, so new handlers aren't registered
   - However, THIS IS ACTUALLY CORRECT - the handlers should persist
   - Real issue: The effect works, but there may be a z-index or event propagation issue

3. **Map flashes/re-renders when marker is placed**
   - Marker style changes: `element.style.display = 'block'` (line 119)
   - Scale animation: `element.style.transform = 'scale(1.3)'` (line 122)
   - Root cause: Multiple synchronous DOM manipulations cause layout thrashing
   - No batching of style updates

**Key Discoveries:**
- Marker is created once per map load (line 138-158)
- Marker element manipulation happens on every click (lines 114-128)
- Cursor tracking uses RAF throttling which is good (line 179)
- Help menu receives cursorCoords via props (line 274)

## Desired End State

After implementation:
1. Right-clicking the map triggers location selection, displays marker, and fetches data
2. Cursor coordinates update smoothly and continuously as mouse moves over map
3. No visible flashing or jarring re-renders when marker is placed
4. Marker appears with smooth, subtle animation
5. All functionality works reliably across different timing scenarios

**Verification:**
- Right-click anywhere on map → marker appears, sidebar loads with data
- Move mouse around map → coordinates in help menu update in real-time
- Right-click multiple locations rapidly → no visual glitches or flashing
- No console errors related to null refs or event handlers
- Marker animation is smooth and professional

## What We're NOT Doing

- Not changing left-click behavior (left-click+drag remains for panning)
- Not adding double-click interactions
- Not changing the marker icon or overall styling
- Not modifying the MapHelpMenu layout or design
- Not adding new features - only fixing existing bugs

## Implementation Approach

Fix each issue independently with focused changes:
1. Fix marker timing by ensuring marker is created before right-click handler
2. Verify cursor tracking works (likely already working, may just need testing)
3. Batch marker DOM updates to prevent layout thrashing using requestAnimationFrame

Use defensive programming to prevent null reference errors.

---

## Phase 1: Fix Marker Initialization Race Condition

### Overview

Ensure the marker is fully created and available before the right-click handler tries to use it. Separate marker creation into its own effect that runs earlier, and add null checks.

### Changes Required:

#### 1. SSTMap Component - Restructure Marker Creation Timing

**File**: `src/components/SSTMap.tsx`

**Changes**: Create marker in a separate, earlier effect and add defensive null checks

Update the marker creation effect (lines 138-158) to be more defensive:

```tsx
// Create marker once when map loads
useEffect(() => {
  if (!map.current || !isMapLoaded || marker.current) return

  console.log('Creating marker...')

  // Create marker element with Lucide icon
  const el = document.createElement('div')
  el.className = 'map-marker'
  el.innerHTML = renderToString(
    <MapPin className="w-8 h-8 text-cyan-600 drop-shadow-lg" fill="white" strokeWidth={2} />
  )
  el.style.cursor = 'pointer'
  el.style.transition = 'transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)'

  // Initialize marker (hidden initially)
  marker.current = new maplibregl.Marker({ element: el })
    .setLngLat([0, 0])
    .addTo(map.current)
  marker.current.getElement().style.display = 'none'

  console.log('Marker created successfully:', marker.current)

  return () => {
    if (marker.current) {
      marker.current.remove()
      marker.current = null
      console.log('Marker cleaned up')
    }
  }
}, [isMapLoaded])
```

Update the right-click handler (lines 105-136) with better null checking and logging:

```tsx
// Handle map right-clicks
useEffect(() => {
  if (!map.current || !onMapClick || !isMapLoaded) return

  const handleRightClick = (e: maplibregl.MapMouseEvent) => {
    e.preventDefault() // Prevent browser context menu
    console.log('Right click at:', e.lngLat.lat, e.lngLat.lng)

    // Call the parent handler to fetch data
    onMapClick(e.lngLat.lat, e.lngLat.lng)

    // Update marker position - with defensive checks
    if (marker.current) {
      console.log('Updating marker position')
      const element = marker.current.getElement()
      marker.current.setLngLat([e.lngLat.lng, e.lngLat.lat])
      element.style.display = 'block'

      // Animate marker (batched in next phase)
      element.style.transform = 'scale(1.3)'
      setTimeout(() => {
        element.style.transform = 'scale(1)'
      }, 300)
    } else {
      console.warn('Marker not available yet!')
    }
  }

  map.current.on('contextmenu', handleRightClick)

  return () => {
    map.current?.off('contextmenu', handleRightClick)
  }
}, [onMapClick, isMapLoaded])
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compilation passes: `pnpm build`
- [x] No linting errors: `pnpm lint`
- [x] All tests pass: `pnpm test`

#### Manual Verification:
- [x] Right-click on map → marker appears at clicked location
- [x] Right-click triggers data fetch (sidebar opens with loading state)
- [x] Console shows "Right click at:" followed by coordinates
- [x] Console shows "Updating marker position" (not "Marker not available yet!")
- [x] Marker appears consistently, even on first right-click after page load
- [x] No console errors about null refs
- [x] Multiple rapid right-clicks work without errors

---

## Phase 2: Verify and Fix Cursor Tracking

### Overview

Verify that cursor tracking is working correctly. If not, fix the event handler registration and ensure coordinates update continuously.

### Changes Required:

#### 1. SSTMap Component - Verify Cursor Tracking Effect

**File**: `src/components/SSTMap.tsx`

**Changes**: Review and test the existing cursor tracking implementation

The current implementation (lines 167-204) should already work correctly:

```tsx
// Track cursor position for coordinate display
useEffect(() => {
  if (!map.current || !isMapLoaded) return

  let rafId: number | null = null

  const handleMouseMove = (e: maplibregl.MapMouseEvent) => {
    // Use requestAnimationFrame to throttle updates
    if (rafId) {
      cancelAnimationFrame(rafId)
    }

    rafId = requestAnimationFrame(() => {
      setCursorCoords({
        lat: e.lngLat.lat,
        lon: e.lngLat.lng,
      })
    })
  }

  const handleMouseLeave = () => {
    if (rafId) {
      cancelAnimationFrame(rafId)
    }
    setCursorCoords(null)
  }

  map.current.on('mousemove', handleMouseMove)
  map.current.on('mouseleave', handleMouseLeave)

  return () => {
    if (rafId) {
      cancelAnimationFrame(rafId)
    }
    map.current?.off('mousemove', handleMouseMove)
    map.current?.off('mouseleave', handleMouseLeave)
  }
}, [isMapLoaded])
```

**Analysis**: This code looks correct. The `[isMapLoaded]` dependency is appropriate because:
- The effect sets up event listeners once when the map loads
- The cleanup function removes them when component unmounts
- The handlers use closures to access `setCursorCoords` which is stable
- RAF throttling prevents performance issues

**If cursor tracking isn't working**, the issue is likely:
1. The MapHelpMenu isn't receiving the props correctly
2. There's a CSS z-index issue preventing mouse events
3. The map container is being recreated somehow

Add debugging to verify:

```tsx
// Track cursor position for coordinate display
useEffect(() => {
  if (!map.current || !isMapLoaded) return

  console.log('Setting up cursor tracking...')
  let rafId: number | null = null

  const handleMouseMove = (e: maplibregl.MapMouseEvent) => {
    // Use requestAnimationFrame to throttle updates
    if (rafId) {
      cancelAnimationFrame(rafId)
    }

    rafId = requestAnimationFrame(() => {
      const coords = {
        lat: e.lngLat.lat,
        lon: e.lngLat.lng,
      }
      // Uncomment for debugging:
      // console.log('Cursor coords:', coords)
      setCursorCoords(coords)
    })
  }

  const handleMouseLeave = () => {
    if (rafId) {
      cancelAnimationFrame(rafId)
    }
    setCursorCoords(null)
  }

  map.current.on('mousemove', handleMouseMove)
  map.current.on('mouseleave', handleMouseLeave)

  console.log('Cursor tracking listeners attached')

  return () => {
    if (rafId) {
      cancelAnimationFrame(rafId)
    }
    map.current?.off('mousemove', handleMouseMove)
    map.current?.off('mouseleave', handleMouseLeave)
    console.log('Cursor tracking listeners removed')
  }
}, [isMapLoaded])
```

#### 2. MapHelpMenu - Verify Props Rendering

**File**: `src/components/MapHelpMenu.tsx`

**Changes**: Add debugging to confirm props are received

Add temporary logging to the component (line 11):

```tsx
export function MapHelpMenu({ cursorCoords, isLoading }: MapHelpMenuProps) {
  const [isMinimized, setIsMinimized] = useState(false)

  // Temporary debugging - remove after verification
  useEffect(() => {
    if (cursorCoords) {
      console.log('MapHelpMenu received coords:', cursorCoords)
    }
  }, [cursorCoords])

  // ... rest of component
}
```

Don't forget to import useEffect:
```tsx
import { useState, useEffect } from 'react'
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compilation passes: `pnpm build`
- [x] No linting errors: `pnpm lint`

#### Manual Verification:
- [x] Move mouse over map → console shows "Setting up cursor tracking..."
- [x] Move mouse continuously → coordinates in help menu update smoothly
- [x] Coordinates display format: "XX.XXXX, YY.YYYY" (4 decimal places)
- [x] Move mouse off map → coordinates change to "—"
- [x] Move mouse back on map → coordinates resume updating
- [x] No lag or stuttering in coordinate updates
- [x] Console shows "MapHelpMenu received coords" continuously while moving (can remove after verification)

---

## Phase 3: Fix Map Flashing with Batched DOM Updates

### Overview

Eliminate visual flashing by batching marker DOM style updates into a single animation frame, preventing layout thrashing and reducing repaints.

### Changes Required:

#### 1. SSTMap Component - Batch Marker Style Updates

**File**: `src/components/SSTMap.tsx`

**Changes**: Use requestAnimationFrame to batch all marker style changes

Replace the marker update code in the right-click handler (lines 114-128) with batched updates:

```tsx
// Handle map right-clicks
useEffect(() => {
  if (!map.current || !onMapClick || !isMapLoaded) return

  const handleRightClick = (e: maplibregl.MapMouseEvent) => {
    e.preventDefault() // Prevent browser context menu

    // Call the parent handler to fetch data
    onMapClick(e.lngLat.lat, e.lngLat.lng)

    // Update marker position - batched for performance
    if (marker.current) {
      const element = marker.current.getElement()
      const newLngLat: [number, number] = [e.lngLat.lng, e.lngLat.lat]

      // Batch all style updates in a single animation frame
      requestAnimationFrame(() => {
        // Update position and visibility together
        marker.current!.setLngLat(newLngLat)
        element.style.display = 'block'
        element.style.transform = 'scale(1.3)'

        // Reset scale after animation
        setTimeout(() => {
          requestAnimationFrame(() => {
            element.style.transform = 'scale(1)'
          })
        }, 300)
      })
    } else {
      console.warn('Marker not available yet!')
    }
  }

  map.current.on('contextmenu', handleRightClick)

  return () => {
    map.current?.off('contextmenu', handleRightClick)
  }
}, [onMapClick, isMapLoaded])
```

#### 2. Optimize Marker Creation Transition

**File**: `src/components/SSTMap.tsx`

**Changes**: Ensure smooth transitions without forcing synchronous layouts

Update marker element creation (around line 145) to use GPU-accelerated properties:

```tsx
// Create marker element with Lucide icon
const el = document.createElement('div')
el.className = 'map-marker'
el.innerHTML = renderToString(
  <MapPin className="w-8 h-8 text-cyan-600 drop-shadow-lg" fill="white" strokeWidth={2} />
)
el.style.cursor = 'pointer'
// Use transform and opacity for GPU acceleration
el.style.transition = 'transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.2s ease'
el.style.willChange = 'transform, opacity' // Hint for browser optimization
el.style.opacity = '0' // Start invisible for smooth fade-in
```

Update the marker show/hide logic to use opacity instead of display:

```tsx
// Initialize marker (hidden initially)
marker.current = new maplibregl.Marker({ element: el })
  .setLngLat([0, 0])
  .addTo(map.current)
const markerEl = marker.current.getElement()
markerEl.style.opacity = '0'
markerEl.style.transform = 'scale(0.8)'
```

Update the show logic in the right-click handler:

```tsx
// Batch all style updates in a single animation frame
requestAnimationFrame(() => {
  // Update position and visibility together
  marker.current!.setLngLat(newLngLat)
  element.style.opacity = '1' // Fade in
  element.style.transform = 'scale(1.3)' // Bounce up

  // Reset scale after animation
  setTimeout(() => {
    requestAnimationFrame(() => {
      element.style.transform = 'scale(1)'
    })
  }, 300)
})
```

Update the hide logic in the hasSelection effect (lines 161-165):

```tsx
// Hide marker when selection is cleared
useEffect(() => {
  if (!hasSelection && marker.current) {
    const element = marker.current.getElement()
    requestAnimationFrame(() => {
      element.style.opacity = '0'
      element.style.transform = 'scale(0.8)'
    })
  }
}, [hasSelection])
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compilation passes: `pnpm build`
- [x] No linting errors: `pnpm lint`
- [x] All tests pass: `pnpm test`

#### Manual Verification:
- [x] Right-click on map → no visible flash or jank
- [x] Marker appears smoothly with subtle fade-in and bounce
- [x] Right-click different location → marker moves smoothly without flashing
- [x] Multiple rapid right-clicks → no accumulated visual glitches
- [x] Close sidebar → marker fades out smoothly
- [x] Map doesn't flicker or jump when marker appears
- [x] Smooth 60fps animations on both desktop and mobile
- [x] No layout shift when marker is placed

---

## Phase 4: Polish and Cleanup

### Overview

Remove debugging console.logs, verify all edge cases, and ensure the implementation is production-ready.

### Changes Required:

#### 1. SSTMap Component - Remove Debug Logging

**File**: `src/components/SSTMap.tsx`

**Changes**: Remove all temporary console.log statements added during debugging

Remove or comment out these logs:
- Line ~143: "Creating marker..."
- Line ~156: "Marker created successfully:"
- Line ~111: "Right click at:"
- Line ~116: "Updating marker position"
- Line ~128: "Marker not available yet!" (keep this as console.warn)
- Line ~169: "Setting up cursor tracking..."
- Line ~195: "Cursor tracking listeners attached"
- Line ~202: "Cursor tracking listeners removed"
- Line ~161: "Marker cleaned up"

Keep only critical warnings:
```tsx
if (!marker.current) {
  console.warn('Marker not available for right-click interaction')
}
```

#### 2. MapHelpMenu - Remove Debug Code

**File**: `src/components/MapHelpMenu.tsx`

**Changes**: Remove temporary debugging useEffect

Remove the debugging useEffect added in Phase 2:
```tsx
// Remove this entire block:
useEffect(() => {
  if (cursorCoords) {
    console.log('MapHelpMenu received coords:', cursorCoords)
  }
}, [cursorCoords])
```

And remove the useEffect import if it was only added for debugging:
```tsx
// Change from:
import { useState, useEffect } from 'react'
// Back to:
import { useState } from 'react'
```

#### 3. Update Help Menu Text

**File**: `src/components/MapHelpMenu.tsx`

**Changes**: Update the interaction hint to reflect right-click-only behavior

Update line 70:
```tsx
<div className="text-slate-700">
  Right-click map to select location
</div>
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compilation passes: `pnpm build`
- [x] No linting errors: `pnpm lint`
- [x] All tests pass: `pnpm test`

#### Manual Verification:
- [x] Console is clean (no debug logs during normal operation)
- [x] Only warnings appear for actual error conditions
- [x] Help menu shows "Right-click map to select location"
- [x] All three original bugs are fixed:
  - [x] Right-click triggers location selection and search
  - [x] Cursor coordinates update continuously
  - [x] No map flashing when marker is placed
- [x] Edge cases work correctly:
  - [x] First right-click after page load works
  - [x] Rapid multiple right-clicks work smoothly
  - [x] Right-clicking while data is loading doesn't break anything
  - [x] Marker persists during loading state
  - [x] Closing sidebar hides marker smoothly
- [x] Performance is smooth (60fps animations)
- [x] Works correctly on both desktop and mobile

---

## Testing Strategy

### Manual Testing Checklist

**Basic Functionality:**
1. Load app → wait for map to load
2. Right-click any location → verify marker appears and sidebar loads
3. Move mouse around map → verify coordinates update in help menu
4. Right-click different location → verify marker moves smoothly
5. Verify no console errors or warnings (except expected ones)

**Edge Cases:**
1. Right-click immediately after page load (test race condition fix)
2. Right-click multiple times rapidly in different locations
3. Right-click while previous data is still loading
4. Move mouse very quickly across map (test RAF throttling)
5. Close sidebar and verify marker disappears
6. Minimize/maximize help menu while using map

**Visual Quality:**
1. Watch for any flashing, flickering, or jerky animations
2. Verify marker animation is smooth and subtle
3. Verify cursor coordinates update smoothly (no stuttering)
4. Verify map doesn't jump or shift when marker appears

**Performance:**
1. Open browser dev tools → Performance tab
2. Record interaction while right-clicking and moving mouse
3. Verify no long tasks or layout thrashing
4. Verify 60fps during animations

**Cross-browser Testing:**
- Chrome (desktop)
- Firefox (desktop)
- Safari (desktop)
- Safari iOS (mobile)
- Chrome Android (mobile)

### Debugging Tips

If issues persist after implementation:

1. **Marker still not appearing:**
   - Check console for "Marker not available" warning
   - Verify marker.current is set before right-click handler runs
   - Check if marker element is hidden by CSS or z-index

2. **Cursor coords not updating:**
   - Check if mousemove events are firing (add temporary log)
   - Verify cursorCoords state is changing (React DevTools)
   - Check if MapHelpMenu is receiving updated props
   - Verify no CSS is blocking pointer events

3. **Still seeing flashing:**
   - Check browser Paint Flashing tool in DevTools
   - Verify requestAnimationFrame is being used
   - Check if other effects are triggering re-renders
   - Profile with Performance tab to find layout thrashing

## Performance Considerations

- **requestAnimationFrame batching**: Ensures DOM updates happen during the browser's paint cycle, preventing layout thrashing
- **GPU-accelerated properties**: Using `transform` and `opacity` instead of `display` and positioning keeps animations on the GPU
- **RAF throttling for cursor**: Prevents excessive setState calls during mousemove
- **will-change hint**: Tells browser to optimize for transform/opacity changes
- **Event listener cleanup**: Proper cleanup prevents memory leaks

Expected performance:
- Marker animation: 60fps
- Cursor tracking: ~60 updates/second (RAF throttled)
- No forced synchronous layouts
- Paint time: <10ms per frame

## Migration Notes

No data migration or breaking changes. This is a bug fix that improves existing functionality.

**Deployment:**
- Can be deployed immediately
- No feature flags needed
- No database changes
- No API changes
- Users will see immediate improvement in map interactions

**Backwards Compatibility:**
- All existing functionality preserved
- Component APIs unchanged
- No breaking changes to parent components

## References

- Current implementation: `src/components/SSTMap.tsx:1`
- Help menu component: `src/components/MapHelpMenu.tsx:1`
- Parent component: `src/routes/index.tsx:129-136`
- MapLibre Marker API: https://maplibre.org/maplibre-gl-js/docs/API/classes/Marker/
- MapLibre Map Events: https://maplibre.org/maplibre-gl-js/docs/API/classes/Map/#events
- requestAnimationFrame guide: https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame
